{% extends 'base.html' %}

{% load static %}
{% load custom_tags %}

{% block title %}Mon Parcours{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<h1 class="title-dashboard">Mon Parcours</h1>

<div class="container-dashboard">
  <h2>Cursus achet√©s</h2>
  <ul>
    {% for entry in theme_with_curriculums %}
      {% with theme=entry.theme curriculums=entry.curriculums %}
        <li>
          <div class="theme-block">
            <div class="theme-line">
              <span class="theme-title">Th√®me : {{ theme.name }}</span>
              {% with theme_progress_by_theme|get_item:theme.id as progress %}
                <div class="theme-progress-group"> 
                  <div class="theme-progress-bar">
                    <div class="progress" style="width: {{ progress }}%;"></div>
                  </div>
                  <small class="progress-text">{{ progress }}% compl√©t√©</small>
                </div>
            </div> 

            {% if progress == 100 %}
              <div class="certificate-container">
                <a href="{% url 'view_certificate' theme.id %}" class="certificate-link">
                  üéì Acc√©der √† mon certificat
                </a>
              </div>
            {% endif %}
            {% endwith %}
          </div>
          
          <ul>
            {% for item in curriculums %}
              {% with curriculum=item.curriculum purchased=item.purchased progress=item.progress %}
                <li>
                  <div class="cursus-content">
                    {% if purchased %}
                      {{ curriculum.title }}
                      <ul>
                        {% for lesson in curriculum.lessons.all %}
                          <li class="lesson-item">
                            <div class="lesson-content">
                              <a href="{% url 'lesson_detail' lesson.id %}" class="lesson-link">
                                {{ lesson.title }}
                              </a>
                              {% if lesson.id in completed_lessons_ids %} 
                                <span class="status-icon">‚úÖ</span>
                              {% else %}
                                <span class="status-icon">‚ùå</span>
                              {% endif %}
                            </div>
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <a href="#" class="cursus-link locked-lesson" onClick="showErrorMessage(event, 'cursus')">
                        üîí {{ curriculum.title }}
                      </a>
                    {% endif %}
                  </div>
                </li>
              {% endwith %}
            {% endfor %}
          </ul>
        </li>
      {% endwith %}
    {% endfor %}
  </ul>

  <h2>Le√ßons achet√©es individuellement</h2>
  {% if standalone_lessons_by_theme %}
    <ul>
      {% for theme, curriculums in standalone_lessons_by_theme.items %}
        <li>
          <div class="theme-block">
            <div class="theme-line">
              <span class="theme-title">Th√®me : {{ theme.name }}</span>
              {% with standalone_progress_by_theme|get_item:theme.id as progress %}
                <div class="theme-progress-group"> 
                  <div class="theme-progress-bar">
                    <div class="progress" style="width: {{ progress }}%;"></div>
                  </div>
                  <small class="progress-text">{{ progress }}% compl√©t√©</small>
                </div>
            </div>

            {% if progress == 100 %}
              <div class="certificate-container">
                <a href="{% url 'view_certificate' theme.id %}" class="certificate-link">
                  üéì Acc√©der √† mon certificat
                </a>
              </div>
            {% endif %}
            {% endwith %}
          </div>

          <ul>
            {% for curriculum, lessons in curriculums.items %}
              <li>
                <div class="cursus-content">
                  {{ curriculum.title }}
                  <ul>
                    {% for lesson_data in lessons %}
                      <li class="lesson-item">
                        <div class="lesson-content">
                          {% if lesson_data.purchased %}
                            <a href="{% url 'lesson_detail' lesson_data.lesson.id %}" class="lesson-link">
                              {{ lesson_data.lesson.title }}
                            </a>
                            {% if lesson_data.validated %} 
                              <span class="status-icon">‚úÖ</span> 
                            {% else %}
                              <span class="status-icon">‚ùå</span>
                            {% endif %}
                          {% else %}
                            <a href="#" class="lesson-link locked-lesson" onClick="showErrorMessage(event)">
                              üîí {{ lesson_data.lesson.title }}
                            </a>
                            <span class="status-icon"></span>
                          {% endif %}
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </li>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Vous n'avez achet√© aucune le√ßon individuellement.</p>
  {% endif %}       
</div>

<div id="message-container" class="message-container hidden">
  <p class="error-message">Vous devez acheter cette le√ßon pour y acc√©der.</p>
</div>

<script>
  function showErrorMessage(event, type) {
    event.preventDefault();
    const messageContainer = document.getElementById('message-container');
    const messageText = messageContainer.querySelector('.error-message');

    if (type === 'cursus') {
      messageText.textContent = "Vous devez acheter ce cursus pour y acc√©der.";
    } else {
      messageText.textContent = "Vous devez acheter cette le√ßon pour y acc√©der.";
    }

    messageContainer.classList.remove('hidden');

    setTimeout(() => {
      messageContainer.classList.add('hidden');
    }, 4000);
  }
</script>

{% endblock %}
